var e,t,n=require("base-64"),r=require("uuid"),i=require("immer"),o=(e=i)&&"object"==typeof e&&"default"in e?e.default:e,c=require("firebase/app");function s(e){return void 0!==e.setReference}require("firebase/firestore");var u=function(){function e(e,n,r){this[t]=!0,this.reference=n,this.data=e,this.collections=r,this.setReferenceToSubCollections()}var n=e.prototype;return n.setReferenceToSubCollections=function(){var e=this;null!=this.collections&&Object.values(this.collections).forEach(function(t){s(t)&&t.setReference(e.reference.collection(t.id))})},n.id=function(){return this.data.id},n.modifyData=function(e){return o(this.data,function(t){Object.assign(t,e)})},e}();function l(e,t){Object.values(e).forEach(function(e){void 0!==e.db&&s(e)&&(e.db=t,e.setReference(t.collection(e.id)))})}t=i.immerable;var a=function(){function e(e,t){this.subscriptions=[],this.id=e,this.db=null,this.reference=null,this.collections=t,this.nextVisibleIndex=0}var t=e.prototype;return t.setReference=function(e){this.reference=e,null!=this.db&&null!=this.collections&&l(this.collections,this.db)},t.createDocument=function(e,t){try{var n=function(){return new u(l,a,i.collections)},i=this,c=i.getCollectionReference(),s=e.id?e.id:r.v4(),l=o(e,function(e){e.id=s}),a=c.doc(s),f=function(){if(!t)return Promise.resolve(a.set(l,{merge:!0})).then(function(){});a.set(l,{merge:!0})}();return Promise.resolve(f&&f.then?f.then(n):n())}catch(e){return Promise.reject(e)}},t.getDocument=function(e){try{var t=this,n=t.getCollectionReference().doc(e);return Promise.resolve(n.get()).then(function(e){if(e.exists){var r=e.data();return new u(r,n,t.collections)}throw Error("Document does not exist, check your id")})}catch(e){return Promise.reject(e)}},t.get=function(e,t,n,r){try{var i=this,o=i.getCollectionReference(),c=i.getQuery(o,e,t,n,r);return Promise.resolve(c.get()).then(function(e){return e.empty?[]:(i.nextVisibleIndex+=e.size+1,e.docs.map(function(e){var t=e.data();return new u(t,e.ref,i.collections)}))})}catch(e){return Promise.reject(e)}},t.updateDocument=function(e){try{var t=this,n=t.getCollectionReference().doc(e.id);return Promise.resolve(n.update(e)).then(function(){return new u(e,n,t.collections)})}catch(e){return Promise.reject(e)}},t.deleteDocument=function(e){try{var t=this.getCollectionReference();return Promise.resolve(t.doc(e).delete()).then(function(){})}catch(e){return Promise.reject(e)}},t.subscribeToDocument=function(e,t,n,r){var i=this,o=this.getCollectionReference().doc(e).onSnapshot(function(e){if(e.exists){var n=e.data(),o=new u(n,e.ref,i.collections);t(o)}else r()},function(e){n(e)});return this.subscriptions.push(o),o},t.subscribe=function(e,t,n,r,i){var o=this,c=this.getCollectionReference(),s=this.getQuery(c,n,r,void 0,i).onSnapshot(function(t){if(t.empty)e([]);else{var n=t.docs.map(function(e){var t=e.data();return new u(t,e.ref,o.collections)});e(n)}},function(e){t(e)});return this.subscriptions.push(s),s},t.subscribeWithDiffing=function(e,t,n,r,i){var o=this,c=this.getCollectionReference(),s=this.getQuery(c,n,r,void 0,i).onSnapshot(function(t){if(!t.empty){var n=new Map;t.docChanges().forEach(function(e){var t=e.doc.data();switch(e.type){case"added":case"modified":n.set(t.id,new u(t,e.doc.ref,o.collections));break;case"removed":n.delete(t.id)}}),e(n)}},function(e){t(e)});return this.subscriptions.push(s),s},t.removeAllSubscriptions=function(){this.subscriptions.forEach(function(e){return e()})},t.resetPagination=function(){this.nextVisibleIndex=0},t.getCollectionReference=function(){if(null!=this.reference&&void 0!==this.reference.doc)return this.reference;throw Error("No reference set or is a document reference")},t.getQuery=function(e,t,n,r,i){var o=e;return null!=t&&(o=o.orderBy(t.property,t.direction)),null!=n&&(o=o.where(n.property,n.direction,n.value)),null!=r&&(o=null!=r.page?o.startAt(r.pageSize*r.page+(r.page>0?1:0)).limit(r.pageSize):o.startAt(this.nextVisibleIndex).limit(r.pageSize)),null!=i&&(o=i(o)),o},e}(),f=function(e){var t,n;function r(){return e.apply(this,arguments)||this}return n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,r}(a);global.btoa||(global.btoa=n.encode),global.atob||(global.atob=n.decode),exports.Collection=a,exports.Database=function(e){this.db=c.firestore(),l(e,this.db),this.collections=e},exports.Document=u,exports.SubCollection=f,exports.isCollectionReference=function(e){return void 0!==e.doc},exports.isDocumentReference=function(e){return void 0!==e.collection};
//# sourceMappingURL=index.js.map
