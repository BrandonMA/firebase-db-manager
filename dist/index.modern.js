import{encode as e,decode as t}from"base-64";import{v4 as n}from"uuid";import i,{immerable as o}from"immer";import{firestore as r}from"firebase/app";import"firebase/firestore";function c(e){return void 0!==e.setReference}var s,u=function(){function e(e,t,n){this[s]=!0,this.reference=t,this.data=e,this.collections=n,this.setReferenceToSubCollections()}var t=e.prototype;return t.setReferenceToSubCollections=function(){var e=this;null!=this.collections&&Object.values(this.collections).forEach(function(t){c(t)&&t.setReference(e.reference.collection(t.id))})},t.id=function(){return this.data.id},t.modifyData=function(e){return i(this.data,function(t){Object.assign(t,e)})},e}();function l(e,t){Object.values(e).forEach(function(e){void 0!==e.db&&c(e)&&(e.db=t,e.setReference(t.collection(e.id)))})}s=o;var f=function(){function e(e,t){this.subscriptions=[],this.id=e,this.db=null,this.reference=null,this.collections=t,this.nextVisibleIndex=0}var t=e.prototype;return t.setReference=function(e){this.reference=e,null!=this.db&&null!=this.collections&&l(this.collections,this.db)},t.createDocument=function(e,t){try{var o=function(){return new u(l,f,r.collections)},r=this,c=r.getCollectionReference(),s=e.id?e.id:n(),l=i(e,function(e){e.id=s}),f=c.doc(s),a=function(){if(!t)return Promise.resolve(f.set(l,{merge:!0})).then(function(){});f.set(l,{merge:!0})}();return Promise.resolve(a&&a.then?a.then(o):o())}catch(e){return Promise.reject(e)}},t.getDocument=function(e){try{var t=this,n=t.getCollectionReference().doc(e);return Promise.resolve(n.get()).then(function(e){if(e.exists){var i=e.data();return new u(i,n,t.collections)}throw Error("Document does not exist, check your id")})}catch(e){return Promise.reject(e)}},t.get=function(e,t,n,i){try{var o=this,r=o.getCollectionReference(),c=o.getQuery(r,e,t,n,i);return Promise.resolve(c.get()).then(function(e){return e.empty?[]:(o.nextVisibleIndex+=e.size+1,e.docs.map(function(e){var t=e.data();return new u(t,e.ref,o.collections)}))})}catch(e){return Promise.reject(e)}},t.updateDocument=function(e){try{var t=this,n=t.getCollectionReference().doc(e.id);return Promise.resolve(n.update(e)).then(function(){return new u(e,n,t.collections)})}catch(e){return Promise.reject(e)}},t.deleteDocument=function(e){try{var t=this.getCollectionReference();return Promise.resolve(t.doc(e).delete()).then(function(){})}catch(e){return Promise.reject(e)}},t.subscribeToDocument=function(e,t,n,i){var o=this,r=this.getCollectionReference().doc(e).onSnapshot(function(e){if(e.exists){var n=e.data(),r=new u(n,e.ref,o.collections);t(r)}else i()},function(e){n(e)});return this.subscriptions.push(r),r},t.subscribe=function(e,t,n,i,o){var r=this,c=this.getCollectionReference(),s=this.getQuery(c,n,i,void 0,o).onSnapshot(function(t){if(t.empty)e([]);else{var n=t.docs.map(function(e){var t=e.data();return new u(t,e.ref,r.collections)});e(n)}},function(e){t(e)});return this.subscriptions.push(s),s},t.subscribeWithDiffing=function(e,t,n,i,o){var r=this,c=this.getCollectionReference(),s=this.getQuery(c,n,i,void 0,o).onSnapshot(function(t){if(!t.empty){var n=new Map;t.docChanges().forEach(function(e){var t=e.doc.data();switch(e.type){case"added":case"modified":n.set(t.id,new u(t,e.doc.ref,r.collections));break;case"removed":n.delete(t.id)}}),e(n)}},function(e){t(e)});return this.subscriptions.push(s),s},t.removeAllSubscriptions=function(){this.subscriptions.forEach(function(e){return e()})},t.resetPagination=function(){this.nextVisibleIndex=0},t.getCollectionReference=function(){if(null!=this.reference&&void 0!==this.reference.doc)return this.reference;throw Error("No reference set or is a document reference")},t.getQuery=function(e,t,n,i,o){var r=e;return null!=t&&(r=r.orderBy(t.property,t.direction)),null!=n&&(r=r.where(n.property,n.direction,n.value)),null!=i&&(r=null!=i.page?r.startAt(i.pageSize*i.page+(i.page>0?1:0)).limit(i.pageSize):r.startAt(this.nextVisibleIndex).limit(i.pageSize)),null!=o&&(r=o(r)),r},e}(),a=function(e){this.db=r(),l(e,this.db),this.collections=e},h=function(e){var t,n;function i(){return e.apply(this,arguments)||this}return n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,i}(f);function d(e){return void 0!==e.doc}function p(e){return void 0!==e.collection}global.btoa||(global.btoa=e),global.atob||(global.atob=t);export{f as Collection,a as Database,u as Document,h as SubCollection,d as isCollectionReference,p as isDocumentReference};
//# sourceMappingURL=index.modern.js.map
