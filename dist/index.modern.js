import{encode as e,decode as t}from"base-64";import{v4 as n}from"uuid";import r,{immerable as i}from"immer";import{firestore as o}from"firebase/app";import"firebase/firestore";function c(e){return void 0!==e.doc}function s(e){return void 0!==e.setReference}var u,l=function(){function e(e,t,n){this[u]=!0,this.data=e,null!=t&&null!=n&&(this.reference=t,this.collections=n,this.setReferenceToSubCollections())}var t=e.prototype;return t.setReferenceToSubCollections=function(){var e=this;null!=this.collections&&Object.values(this.collections).forEach(function(t){s(t)&&t.setReference(e.reference.collection(t.id))})},t.id=function(){return this.data.id},t.modifyData=function(e){return r(this.data,function(t){Object.assign(t,e)})},e}();function f(e,t){Object.values(e).forEach(function(e){void 0!==e.db&&s(e)&&(e.db=t,e.setReference(t.collection(e.id)))})}u=i;var a=function(){function e(e,t){this.subscriptions=[],this.id=e,this.db=null,this.reference=null,this.collections=t,this.nextVisibleIndex=0}var t=e.prototype;return t.setReference=function(e){this.reference=e,null!=this.db&&null!=this.collections&&f(this.collections,this.db)},t.createDocument=function(e,t){try{var i=function(){return new l(u,f,o.collections)},o=this,c=o.getCollectionReference(),s=e.id?e.id:n(),u=r(e,function(e){e.id=s}),f=c.doc(s),a=function(){if(!t)return Promise.resolve(f.set(u,{merge:!0})).then(function(){});f.set(u,{merge:!0})}();return Promise.resolve(a&&a.then?a.then(i):i())}catch(e){return Promise.reject(e)}},t.getDocument=function(e){try{var t=this,n=t.getCollectionReference().doc(e);return Promise.resolve(n.get()).then(function(e){if(e.exists){var r=e.data();return new l(r,n,t.collections)}throw Error("Document does not exist, check your id")})}catch(e){return Promise.reject(e)}},t.get=function(e,t,n,r){try{var i=this,o=i.getCollectionReference(),c=i.getQuery(o,e,t,n,r);return Promise.resolve(c.get()).then(function(e){return e.empty?[]:(i.nextVisibleIndex+=e.size+1,e.docs.map(function(e){var t=e.data();return new l(t,e.ref,i.collections)}))})}catch(e){return Promise.reject(e)}},t.updateDocument=function(e){try{var t=this,n=t.getCollectionReference().doc(e.id);return Promise.resolve(n.update(e)).then(function(){return new l(e,n,t.collections)})}catch(e){return Promise.reject(e)}},t.deleteDocument=function(e){try{var t=this.getCollectionReference();return Promise.resolve(t.doc(e).delete()).then(function(){})}catch(e){return Promise.reject(e)}},t.subscribeToDocument=function(e,t,n,r){var i=this,o=this.getCollectionReference().doc(e).onSnapshot(function(e){if(e.exists){var n=e.data(),o=new l(n,e.ref,i.collections);t(o)}else r()},function(e){n(e)});return this.subscriptions.push(o),o},t.subscribe=function(e,t,n,r,i){var o=this,c=this.getCollectionReference(),s=this.getQuery(c,n,r,void 0,i).onSnapshot(function(t){if(t.empty)e([]);else{var n=t.docs.map(function(e){var t=e.data();return new l(t,e.ref,o.collections)});e(n)}},function(e){t(e)});return this.subscriptions.push(s),s},t.subscribeWithDiffing=function(e,t,n,r,i){var o=this,c=this.getCollectionReference(),s=this.getQuery(c,n,r,void 0,i).onSnapshot(function(t){if(!t.empty){var n=new Map;t.docChanges().forEach(function(e){var t=e.doc.data();switch(e.type){case"added":case"modified":n.set(t.id,new l(t,e.doc.ref,o.collections));break;case"removed":n.delete(t.id)}}),e(n)}},function(e){t(e)});return this.subscriptions.push(s),s},t.removeAllSubscriptions=function(){this.subscriptions.forEach(function(e){return e()})},t.resetPagination=function(){this.nextVisibleIndex=0},t.getCollectionReference=function(){if(null!=this.reference&&c(this.reference))return this.reference;throw Error("No reference set or is a document reference")},t.getQuery=function(e,t,n,r,i){var o=e;return null!=t&&(o=o.orderBy(t.property,t.direction)),null!=n&&(o=o.where(n.property,n.direction,n.value)),null!=r&&(o=null!=r.page?o.startAt(r.pageSize*r.page+(r.page>0?1:0)).limit(r.pageSize):o.startAt(this.nextVisibleIndex).limit(r.pageSize)),null!=i&&(o=i(o)),o},e}(),h=function(e){this.db=o(),f(e,this.db),this.collections=e},d=function(e){var t,n;function r(){return e.apply(this,arguments)||this}return n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,r}(a);function p(e){return void 0!==e.collection}global.btoa||(global.btoa=e),global.atob||(global.atob=t);export{a as Collection,h as Database,l as Document,d as SubCollection,c as isCollectionReference,p as isDocumentReference};
//# sourceMappingURL=index.modern.js.map
